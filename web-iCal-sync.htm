<!DOCTYPE HTML>
<html lang="en">
    <head>
        <title>Bookmarklet-App</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css" integrity="sha384-X38yfunGUhNzHpBaEBsWLO+A0HDYOQi8ufWDkZ0k9e0eXz/tH3II7uKZ9msv++Ls" crossorigin="anonymous">

        <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">
        <link rel="stylesheet" href="./page.style.css">
    </head>
    <body>
        <div class="header">
            <div class="home-menu pure-menu pure-menu-horizontal pure-menu-fixed">
                <a class="pure-menu-heading" href="">iCalendar sync</a>
            </div>
        </div>

        <div class="splash-container">
            <div class="splash">
                <h1 class="splash-head">Office365â„¢ calendar sync</h1>
                <p class="splash-subhead">
                    Drag the link to your bookmarks bar.
                </p>
                <p>
                    <a href="javascript: (() => { let%20dt=new%20Date,userPrivateTld=%22gmail.com%22,userEmail=%22%22,companyName=%22%22,companyTld=%22%22,dtstamp=dt.getFullYear()+(dt.getMonth()+1%3C10?%220%22:%22%22)+(dt.getMonth()+1)+(dt.getDate()%3C10?%220%22:%22%22)+dt.getDate()+%22T%22+(dt.getHours()%3C10?%220%22:%22%22)+dt.getHours()+(dt.getMinutes()%3C10?%220%22:%22%22)+dt.getMinutes()+(dt.getSeconds()%3C10?%220%22:%22%22)+dt.getSeconds()+%22Z%22;dateToday=dt.getFullYear()+(dt.getMonth()+1%3C10?%220%22:%22%22)+%22-%22+(dt.getMonth()+1)+%22-%22+(dt.getDate()%3C10?%220%22:%22%22)+dt.getDate(),dateNextYear=dt.getFullYear()+1+(dt.getMonth()+1%3C10?%220%22:%22%22)+%22-%22+(dt.getMonth()+1)+%22-%22+(dt.getDate()%3C10?%220%22:%22%22)+dt.getDate(),timeNow=(dt.getHours()%3C10?%220%22:%22%22)+dt.getHours()+%22-%22+(dt.getMinutes()%3C10?%220%22:%22%22)+dt.getMinutes()+%22-%22+(dt.getSeconds()%3C10?%220%22:%22%22)+dt.getSeconds(),reqRangeStart=dateToday,reqRangeEnd=dateNextYear,reqCanaryId=null,calTimeZone=%22Europe/Vienna%22,appTld=%22outlook.office.com%22,appTldSuffix=%22/calendar/view/month/%22;let%20currentLocation=document.location.href,appTldPrefix=%22https://%22;if(!currentLocation.includes(appTld))%7Bconsole.log(%22***%20Robot:%20I%20can%20only%20operate%20on%20the%20TLD%20%22+appTld);window.location.href=appTldPrefix+appTld+appTldSuffix%7Dconst%20cookieName=%22X-OWA-CANARY%22,cookieValue=%60;%20$%7Bdocument.cookie%7D%60,cookieParts=cookieValue.split(%60;%20$%7BcookieName%7D=%60);if(cookieParts.length===2)%7BreqCanaryId=cookieParts.pop().split(%22;%22).shift()%7Delse%7Bconsole.log(%22***%20Problem%20detected:%20can%20not%20find%20OWA%20Canary%20Id.%22)%7Dasync%20function%20doDataRequest(reqCanaryId)%7Blet%20url=%22https://outlook.office.com/owa/startupdata.ashx?app=Calendar&n=0%22,res=await%20fetch(url,%7Bmethod:%22POST%22,headers:%7B%22x-owa-canary%22:reqCanaryId,action:%22StartupData%22,%22x-req-source%22:%22Calendar%22%7D%7D);if(res.ok)%7Blet%20ret=await%20res.json(),jsonDataPath=ret.findFolders.Body.ResponseMessages.Items%5B0%5D.RootFolder.Folders;userEmail=ret.owaUserConfig.SessionSettings.UserEmailAddress;companyTld=ret.owaUserConfig.SessionSettings.OrganizationDomain;companyName=ret.owaUserConfig.SessionSettings.CompanyName;calTimeZone=ret.owaUserConfig.UserOptions.MailboxTimeZoneOffset%5B0%5D%5B%22IanaTimeZones%22%5D%5B0%5D;calTimeZoneMS=ret.owaUserConfig.UserOptions.TimeZone;return%20ret.findFolders&&ret.findFolders.Body?jsonDataPath:%7Bsuccess:false,msg:%22No%20Folder%20found.%22%7D%7Delse%7Breturn%60HTTP%20error:%20$%7Bres.status%7D%60%7D%7Dasync%20function%20doCalendarRequest(reqFolderId,reqCanaryId)%7Blet%20url=%22https://outlook.office.com/owa/service.svc?action=GetCalendarView&app=Calendar&n=0%22,res=await%20fetch(url,%7Bmethod:%22POST%22,headers:%7B%22x-owa-canary%22:reqCanaryId,action:%22GetCalendarView%22,%22x-req-source%22:%22Calendar%22,%22x-owa-urlpostdata%22:%22%257B%2522__type%2522%253A%2522GetCalendarViewJsonRequest%253A%2523Exchange%2522%252C%2522Header%2522%253A%257B%2522__type%2522%253A%2522JsonRequestHeaders%253A%2523Exchange%2522%252C%2522RequestServerVersion%2522%253A%2522V2018_01_08%2522%252C%2522TimeZoneContext%2522%253A%257B%2522__type%2522%253A%2522TimeZoneContext%253A%2523Exchange%2522%252C%2522TimeZoneDefinition%2522%253A%257B%2522__type%2522%253A%2522TimeZoneDefinitionType%253A%2523Exchange%2522%252C%2522Id%2522%253A%2522%22+encodeURIComponent(calTimeZoneMS)+%22%2522%257D%257D%257D%252C%2522Body%2522%253A%257B%2522__type%2522%253A%2522GetCalendarViewRequest%253A%2523Exchange%2522%252C%2522CalendarId%2522%253A%257B%2522__type%2522%253A%2522TargetFolderId%253A%2523Exchange%2522%252C%2522BaseFolderId%2522%253A%257B%2522__type%2522%253A%2522FolderId%253A%2523Exchange%2522%252C%2522Id%2522%253A%2522%22+encodeURIComponent(reqFolderId)+%22%2522%257D%257D%252C%2522RangeStart%2522%253A%2522%22+reqRangeStart+%22T00%253A00%253A00.000%2522%252C%2522RangeEnd%2522%253A%2522%22+reqRangeEnd+%22T00%253A00%253A00.000%2522%257D%257D%22%7D%7D);if(res.ok)%7Blet%20ret=await%20res.json(),jsonDataPath=ret.Body.Items;return%20ret.Body&&ret.Body.Items?jsonDataPath:%7Bsuccess:false,msg:%22No%20Events%20found.%22%7D%7Delse%7Breturn%60HTTP%20error:%20$%7Bres.status%7D%60%7D%7Dfunction%20fmtDate(date)%7Breturn%20date.replace(%22+01:00%22,%22%22).replaceAll(%22-%22,%22%22).replaceAll(%22:%22,%22%22)%7DdoDataRequest(reqCanaryId).then(data=%3E%7Blet%20folderCounter=0,folderName=%22Kalender%22;data.forEach(folder=%3E%7Bif(folder%5B%22__type%22%5D===%22CalendarFolder:#Exchange%22)%7BfolderCounter++;if(folderCounter===1)%7BreqFolderId=folder.FolderId.Id%7D%7D%7D);return%20reqFolderId%7D).then(function(reqFolderId)%7BdoCalendarRequest(reqFolderId,reqCanaryId).then(data=%3E%7Blet%20calendar=%22%22,iCal=%22BEGIN:VCALENDAR%5Cr%5CnVERSION:2.0%5Cr%5Cn%22,iCalEnd=%22END:VCALENDAR%5Cr%5CnUID:uid+%22+userEmail+%22%5Cr%5CnDTSTAMP:%22+dtstamp+%22%5Cr%5CnPRODID:calendar+%22+userEmail+%22%5Cr%5Cn%22;if(data&&typeof%20data==%22object%22)%7Bdata.forEach(event=%3E%7BiCal+=%22BEGIN:VEVENT%5Cr%5CnTRANSP:TRANSPARENT%5Cr%5CnLOCATION:Meeting%5Cr%5CnCLASS:PUBLIC%5Cr%5CnDTSTAMP:%22+dtstamp+%22%22;iCal+=%22%5Cr%5CnSUMMARY:%22+event.Subject;iCal+=%22%5Cr%5CnDESCRIPTION:%20@%22+event.Organizer.Mailbox.Name;iCal+=%22%5Cr%5CnDTSTART;TZID=Europe/Vienna:%22+fmtDate(event.Start)+%22%5Cr%5CnDTEND;TZID=Europe/Vienna:%22+fmtDate(event.End);iCal+=%22%5Cr%5CnDTSTAMP:%22+dtstamp+%22%5Cr%5CnUID:%22+event.ItemId.Id+%22%5Cr%5CnEND:VEVENT%5Cr%5Cn%22%7D);calendar=iCal+iCalEnd;var%20blob=new%20Blob(%5Bcalendar%5D,%7Btype:%22text/calendar%22%7D),a=document.createElement(%22a%22);var%20e=new%20MouseEvent(%22click%22,%7Bview:window,bubbles:true,cancelable:false%7D);a.download=%22company-cal-events.%22+companyTld+%22--%22+dtstamp+%22.ics%22;a.href=window.URL.createObjectURL(blob);a.dataset.downloadurl=%5B%22text/calendar%22,a.download,a.href%5D.join(%22:%22);a.dispatchEvent(e);if(userPrivateTld!=%22%22)%7Blet%20url=%22https://outlook.office.com/mail/deeplink/compose%22;url+=%22?to=%22+userEmail.replace(companyTld,userPrivateTld);url+=%22&subject=iCal+Sync&body=iCal+%22+companyName+%22%20-%20%22+dtstamp;window.location.href=url%7D%7Delse%7Bconsole.log(data)%7D%7D)%7D); })();" class="pure-button pure-button-primary">
                        iCal sync
                    </a>
                </p>
                <p class="splash-subhead">
                    Then click on it to sync your calendar.
                </p>
            </div>
        </div>
    </body>
</html>