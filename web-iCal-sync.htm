<!DOCTYPE HTML>
<html lang="en">
    <head>
        <title>Bookmarklet</title>
        <meta charset="utf-8">
    </head>
    <body>
        <h1>Bookmark: Outlook / Teams calendar - iCalendar Sync</h1>

        <p>
            Drag the link to your bookmarks bar - then click on it.
        </p>

        <a href="javascript: (() => { let%20dt=new%20Date,userPrivateTld=%22gmail.com%22,userEmail=%22%22,companyName=%22%22,companyTld=%22%22,dtstamp=dt.getFullYear()+(dt.getMonth()+1%3C10?%220%22:%22%22)+(dt.getMonth()+1)+(dt.getDate()%3C10?%220%22:%22%22)+dt.getDate()+%22T%22+(dt.getHours()%3C10?%220%22:%22%22)+dt.getHours()+(dt.getMinutes()%3C10?%220%22:%22%22)+dt.getMinutes()+(dt.getSeconds()%3C10?%220%22:%22%22)+dt.getSeconds()+%22Z%22;dateToday=dt.getFullYear()+(dt.getMonth()+1%3C10?%220%22:%22%22)+%22-%22+(dt.getMonth()+1)+%22-%22+(dt.getDate()%3C10?%220%22:%22%22)+dt.getDate(),dateNextYear=dt.getFullYear()+1+(dt.getMonth()+1%3C10?%220%22:%22%22)+%22-%22+(dt.getMonth()+1)+%22-%22+(dt.getDate()%3C10?%220%22:%22%22)+dt.getDate(),timeNow=(dt.getHours()%3C10?%220%22:%22%22)+dt.getHours()+%22-%22+(dt.getMinutes()%3C10?%220%22:%22%22)+dt.getMinutes()+%22-%22+(dt.getSeconds()%3C10?%220%22:%22%22)+dt.getSeconds(),reqRangeStart=dateToday,reqRangeEnd=dateNextYear,reqCanaryId=null,calTimeZone=%22Europe/Vienna%22,appTld=%22outlook.office.com%22,appTldSuffix=%22/calendar/view/month/%22;let%20currentLocation=document.location.href,appTldPrefix=%22https://%22;if(!currentLocation.includes(appTld))%7Bconsole.log(%22***%20Robot:%20I%20can%20only%20operate%20on%20the%20TLD%20%22+appTld);window.location.href=appTldPrefix+appTld+appTldSuffix%7Dconst%20cookieName=%22X-OWA-CANARY%22,cookieValue=%60;%20$%7Bdocument.cookie%7D%60,cookieParts=cookieValue.split(%60;%20$%7BcookieName%7D=%60);if(cookieParts.length===2)%7BreqCanaryId=cookieParts.pop().split(%22;%22).shift()%7Delse%7Bconsole.log(%22***%20Problem%20detected:%20can%20not%20find%20OWA%20Canary%20Id.%22)%7Dasync%20function%20doDataRequest(e)%7Blet%20t=%22https://outlook.office.com/owa/startupdata.ashx?app=Calendar&n=0%22,a=await%20fetch(t,%7Bmethod:%22POST%22,headers:%7B%22x-owa-canary%22:e,action:%22StartupData%22,%22x-req-source%22:%22Calendar%22%7D%7D);if(a.ok)%7Blet%20e=await%20a.json(),t=e.findFolders.Body.ResponseMessages.Items%5B0%5D.RootFolder.Folders;userEmail=e.owaUserConfig.SessionSettings.UserEmailAddress;companyTld=e.owaUserConfig.SessionSettings.OrganizationDomain;companyName=e.owaUserConfig.SessionSettings.CompanyName;calTimeZone=e.owaUserConfig.UserOptions.MailboxTimeZoneOffset%5B0%5D%5B%22IanaTimeZones%22%5D%5B0%5D;calTimeZoneMS=e.owaUserConfig.UserOptions.TimeZone;return%20e.findFolders&&e.findFolders.Body?t:%7Bsuccess:false,msg:%22No%20Folder%20found.%22%7D%7Delse%7Breturn%60HTTP%20error:%20$%7Ba.status%7D%60%7D%7Dasync%20function%20doCalendarRequest(e,t)%7Blet%20a=%22https://outlook.office.com/owa/service.svc?action=GetCalendarView&app=Calendar&n=0%22,o=await%20fetch(a,%7Bmethod:%22POST%22,headers:%7B%22x-owa-canary%22:t,action:%22GetCalendarView%22,%22x-req-source%22:%22Calendar%22,%22x-owa-urlpostdata%22:%22%257B%2522__type%2522%253A%2522GetCalendarViewJsonRequest%253A%2523Exchange%2522%252C%2522Header%2522%253A%257B%2522__type%2522%253A%2522JsonRequestHeaders%253A%2523Exchange%2522%252C%2522RequestServerVersion%2522%253A%2522V2018_01_08%2522%252C%2522TimeZoneContext%2522%253A%257B%2522__type%2522%253A%2522TimeZoneContext%253A%2523Exchange%2522%252C%2522TimeZoneDefinition%2522%253A%257B%2522__type%2522%253A%2522TimeZoneDefinitionType%253A%2523Exchange%2522%252C%2522Id%2522%253A%2522%22+encodeURIComponent(calTimeZoneMS)+%22%2522%257D%257D%257D%252C%2522Body%2522%253A%257B%2522__type%2522%253A%2522GetCalendarViewRequest%253A%2523Exchange%2522%252C%2522CalendarId%2522%253A%257B%2522__type%2522%253A%2522TargetFolderId%253A%2523Exchange%2522%252C%2522BaseFolderId%2522%253A%257B%2522__type%2522%253A%2522FolderId%253A%2523Exchange%2522%252C%2522Id%2522%253A%2522%22+encodeURIComponent(e)+%22%2522%257D%257D%252C%2522RangeStart%2522%253A%2522%22+reqRangeStart+%22T00%253A00%253A00.000%2522%252C%2522RangeEnd%2522%253A%2522%22+reqRangeEnd+%22T00%253A00%253A00.000%2522%257D%257D%22%7D%7D);if(o.ok)%7Blet%20e=await%20o.json(),t=e.Body.Items;return%20e.Body&&e.Body.Items?t:%7Bsuccess:false,msg:%22No%20Events%20found.%22%7D%7Delse%7Breturn%60HTTP%20error:%20$%7Bo.status%7D%60%7D%7Dfunction%20fmtDate(e)%7Breturn%20e.replace(%22+01:00%22,%22%22).replaceAll(%22-%22,%22%22).replaceAll(%22:%22,%22%22)%7DdoDataRequest(reqCanaryId).then(e=%3E%7Blet%20t=0,a=%22Kalender%22;e.forEach(e=%3E%7Bif(e%5B%22__type%22%5D===%22CalendarFolder:#Exchange%22)%7Bt++;if(t===1)%7BreqFolderId=e.FolderId.Id%7D%7D%7D);return%20reqFolderId%7D).then(function(e)%7BdoCalendarRequest(e,reqCanaryId).then(e=%3E%7Blet%20t=%22%22,a=%22BEGIN:VCALENDAR%5Cr%5CnVERSION:2.0%5Cr%5Cn%22,o=%22END:VCALENDAR%5Cr%5CnUID:uid+%22+userEmail+%22%5Cr%5CnDTSTAMP:%22+dtstamp+%22%5Cr%5CnPRODID:calendar+%22+userEmail+%22%5Cr%5Cn%22;if(e&&typeof%20e==%22object%22)%7Be.forEach(e=%3E%7Ba+=%22BEGIN:VEVENT%5Cr%5CnTRANSP:TRANSPARENT%5Cr%5CnLOCATION:Meeting%5Cr%5CnCLASS:PUBLIC%5Cr%5CnDTSTAMP:%22+dtstamp+%22%22;a+=%22%5Cr%5CnSUMMARY:%22+e.Subject;a+=%22%5Cr%5CnDESCRIPTION:%20@%22+e.Organizer.Mailbox.Name;a+=%22%5Cr%5CnDTSTART;TZID=Europe/Vienna:%22+fmtDate(e.Start)+%22%5Cr%5CnDTEND;TZID=Europe/Vienna:%22+fmtDate(e.End);a+=%22%5Cr%5CnDTSTAMP:%22+dtstamp+%22%5Cr%5CnUID:%22+e.ItemId.Id+%22%5Cr%5CnEND:VEVENT%5Cr%5Cn%22%7D);t=a+o;var%20n=new%20Blob(%5Bt%5D,%7Btype:%22text/calendar%22%7D),r=document.createElement(%22a%22);var%20d=new%20MouseEvent(%22click%22,%7Bview:window,bubbles:true,cancelable:false%7D);r.download=%22company-cal-events.%22+companyTld+%22--%22+dtstamp+%22.ics%22;r.href=window.URL.createObjectURL(n);r.dataset.downloadurl=%5B%22text/calendar%22,r.download,r.href%5D.join(%22:%22);r.dispatchEvent(d);if(userPrivateTld!=%22%22)%7Blet%20e=%22https://outlook.office.com/mail/deeplink/compose%22;e+=%22?to=%22+userEmail.replace(companyTld,userPrivateTld);e+=%22&subject=iCal+Sync&body=iCal+%22+companyName+%22%20-%20%22+dtstamp;window.location.href=e%7D%7Delse%7Bconsole.log(e)%7D%7D)%7D); })();">
            iCal sync
        </a>
    </body>
</html>